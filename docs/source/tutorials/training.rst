Training and Checkpointing
==========================

.. note::
   Make sure you have followed the :doc:`/installation` guide before proceeding.

Distributed Training Configuration
----------------------------------

For an accelerate config example, see `this config file <https://github.com/TensorAuto/OpenTau/blob/main/configs/examples/accelerate_deepspeed_config.yaml>`_ used for our CI pipelines.

To train a model, run the following command:

.. code-block:: bash

    opentau-train --config_path=examples/pi05_config.json

This uses the default accelerate config file at `~/.cache/huggingface/accelerate/default_config.yaml` which is set by running ``accelerate config``.

Optionally, to use a specific accelerate config file (instead of the default), run:

.. code-block:: bash

    opentau-train --accelerate-config=configs/examples/accelerate_deepspeed_config.yaml --config_path=configs/examples/pi05_config.json

.. note::
   For advanced users: ``opentau-train`` is a convenience wrapper that invokes ``accelerate launch`` and `src/opentau/scripts/train.py <https://github.com/TensorAuto/OpenTau/blob/main/src/opentau/scripts/train.py>`_. The command above is equivalent to running:

   .. code-block:: bash

       accelerate launch --config_file configs/examples/accelerate_deepspeed_config.yaml src/opentau/scripts/train.py --config_path=configs/examples/pi05_config.json

Checkpointing and Resuming Training
-----------------------------------

Start training and saving checkpoints:

.. code-block:: bash

    opentau-train --config_path=examples/pi05_config.json --output_dir=outputs/train/pi05 --steps 40 --log_freq 5 --save_freq 20

A checkpoint should be saved at step 40. The checkpoint should be saved in the directory ``outputs/train/pi05/checkpoints/000040/``.

The ``model.safetensors`` file is not automatically generated by DeepSpeed's checkpointing during training. To consolidate the sharded model checkpoint files generated by DeepSpeed into a single ``model.safetensors`` file, run:

.. code-block:: bash

    ./convert_checkpoint.sh outputs/train/pi05/checkpoints/000040/

This generates a ``model.safetensors`` file that can be used for inference or resuming training.

Training can be resumed by running:

.. code-block:: bash

    opentau-train --config_path=outputs/train/pi05/checkpoints/000040/train_config.json --resume=true --steps=100

.. note::
   When resuming training from a checkpoint, the training step count will continue from the checkpoint's step, but the dataloader will be reset.
